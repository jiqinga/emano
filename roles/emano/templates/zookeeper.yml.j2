version: "3"
services:
  zookeeper1:
    image: {{harbor_port}}/emano/confluentinc/cp-zookeeper:v1
    hostname: zookeeper1
    environment:
      - ZOOKEEPER_SERVER_ID=1
      - ZOOKEEPER_CLIENT_PORT=22181
      - ZOOKEEPER_TICK_TIME=2000
      - ZOOKEEPER_INIT_LIMIT=5
      - ZOOKEEPER_SYNC_LIMIT=2
      - ZOOKEEPER_SERVERS=zookeeper1:22888:23888;zookeeper2:32888:33888;zookeeper3:42888:43888
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    ports:
      - "22181:22181"
    volumes:
      - "/etc/localtime:/etc/localtime"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  zookeeper2:
    image: {{harbor_port}}/emano/confluentinc/cp-zookeeper:v1
    hostname: zookeeper2
    environment:
      - ZOOKEEPER_SERVER_ID=2
      - ZOOKEEPER_CLIENT_PORT=32181
      - ZOOKEEPER_TICK_TIME=2000
      - ZOOKEEPER_INIT_LIMIT=5
      - ZOOKEEPER_SYNC_LIMIT=2
      - ZOOKEEPER_SERVERS=zookeeper1:22888:23888;zookeeper2:32888:33888;zookeeper3:42888:43888
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    volumes:
      - "/etc/localtime:/etc/localtime"
    ports:
      - "32181:32181"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  zookeeper3:
    image: {{harbor_port}}/emano/confluentinc/cp-zookeeper:v1
    hostname: zookeeper3
    environment:
      - ZOOKEEPER_SERVER_ID=3
      - ZOOKEEPER_CLIENT_PORT=42181
      - ZOOKEEPER_TICK_TIME=2000
      - ZOOKEEPER_INIT_LIMIT=5
      - ZOOKEEPER_SYNC_LIMIT=2
      - ZOOKEEPER_SERVERS=zookeeper1:22888:23888;zookeeper2:32888:33888;zookeeper3:42888:43888
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    volumes:
      - "/etc/localtime:/etc/localtime"
    ports:
      - "42181:42181"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  kafka-1:
    image: {{harbor_port}}/emano/confluentinc/cp-kafka:v1
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT={{work3}}:22181,{{work3}}:32181,{{work3}}:42181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://{{work3}}:19092
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    ports:
      - "19092:19092"
    volumes:
      - "/etc/localtime:/etc/localtime"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  kafka-2:
    image: {{harbor_port}}/emano/confluentinc/cp-kafka:v1
    hostname: kafka-2
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
    environment:
      - KAFKA_BROKER_ID=2
      - KAFKA_ZOOKEEPER_CONNECT={{work3}}:22181,{{work3}}:32181,{{work3}}:42181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://{{work3}}:29092
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    ports:
      - "29092:29092"
    volumes:
      - "/etc/localtime:/etc/localtime"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  kafka-3:
    image: {{harbor_port}}/emano/confluentinc/cp-kafka:v1
    hostname: kafka-3
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
    environment:
      - KAFKA_BROKER_ID=3
      - KAFKA_ZOOKEEPER_CONNECT={{work3}}:22181,{{work3}}:32181,{{work3}}:42181
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://{{work3}}:39092
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    ports:
      - "39092:39092"
    extra_hosts:
      - "moby:127.0.0.1"
    volumes:
      - "/etc/localtime:/etc/localtime"
    networks:
     - alarmsnet
  kafka-rest-1:
    image: {{harbor_port}}/emano/confluentinc/cp-kafka-rest:v1
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
      - kafka-1
      - kafka-2
      - kafka-3
    environment:
      - KAFKA_REST_ZOOKEEPER_CONNECT=zookeeper1:22181,zookeeper2:32181,zookeeper3:42181
      - KAFKA_REST_LISTENERS=http://0.0.0.0:8082
      - KAFKA_REST_SCHEMA_REGISTRY_URL=http://localhost:8081
      - KAFKA_REST_HOST_NAME=localhost
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    volumes:
      - "/etc/localtime:/etc/localtime"
      - "/emano/kafka-rest-4.0.0.jar:/usr/share/java/kafka-rest/kafka-rest-4.0.0.jar"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  kafka-rest-2:
    image: {{harbor_port}}/emano/confluentinc/cp-kafka-rest:v1
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
      - kafka-1
      - kafka-2
      - kafka-3
    environment:
      - KAFKA_REST_ZOOKEEPER_CONNECT=zookeeper1:22181,zookeeper2:32181,zookeeper3:42181
      - KAFKA_REST_LISTENERS=http://0.0.0.0:8083
      - KAFKA_REST_SCHEMA_REGISTRY_URL=http://localhost:8081
      - KAFKA_REST_HOST_NAME=localhost
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    volumes:
      - "/etc/localtime:/etc/localtime"
      - "/emano/kafka-rest-4.0.0.jar:/usr/share/java/kafka-rest/kafka-rest-4.0.0.jar"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  kafka-rest-3:
    image: {{harbor_port}}/emano/confluentinc/cp-kafka-rest:v1
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
      - kafka-1
      - kafka-2
      - kafka-3
    environment:
      - KAFKA_REST_ZOOKEEPER_CONNECT=zookeeper1:22181,zookeeper2:32181,zookeeper3:42181
      - KAFKA_REST_LISTENERS=http://0.0.0.0:8084
      - KAFKA_REST_SCHEMA_REGISTRY_URL=http://localhost:8081
      - KAFKA_REST_HOST_NAME=localhost
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    volumes:
      - "/etc/localtime:/etc/localtime"
      - "/emano/kafka-rest-4.0.0.jar:/usr/share/java/kafka-rest/kafka-rest-4.0.0.jar"
    extra_hosts:
      - "moby:127.0.0.1"
    networks:
      - alarmsnet
  haproxy-1:
    image: {{harbor_port}}/emano/haproxy:v1
    depends_on:
      - zookeeper-1
      - zookeeper-2
      - zookeeper-3
      - kafka-1
      - kafka-2
      - kafka-3
      - kafka-rest-1
      - kafka-rest-2
      - kafka-rest-3
    volumes:
      - "/etc/localtime:/etc/localtime"
      - "/emano/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg"
    ports:
      - "8520:8520"
    deploy:
      placement:
        constraints: [node.labels.role == alarms]
    networks:
      - alarmsnet
    extra_hosts:
      - "moby:127.0.0.1"
networks:
  alarmsnet:
